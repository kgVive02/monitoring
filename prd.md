# NBP/DR 실시간 전환 모니터링 대시보드 (PRD)

---

## 1. 개요

- 서비스별 **NBP 서버와 DR 서버 간 트래픽 / 세션 비율을 조회**할 수 있는 반응형 웹 대시보드를 제공한다.
- L4 조정, GLB 전환 등 전환 작업 시 **현재 전환 상태를 직관적으로 확인**할 수 있도록 지원한다.

---

## 2. 시스템 구성

### 2.1 서비스 설정 관리 (system.properties 기반)

- 서비스 목록은 서버 내부의 `system.properties` 파일을 기반으로 관리한다.
- Spring 애플리케이션 구동 시 해당 파일을 로딩하여 **설정 정보를 메모리에 등록**한다.
- `system.properties` 파일이 교체 또는 변경되더라도 **서비스 중단 없이 적용**될 수 있어야 한다.
  - 파일 변경 감지 또는 Reload 메커니즘을 통해 in-memory 설정을 갱신한다.

#### 설정 정보 항목
- 서비스 ID
- 서비스명
- 모니터링 타입 (L4 / GLB)
- VIP, Port 정보
- 서버 목록 (NBP / DR)
- SNMP 대상 IP, Community, OID 정보

---

## 3. 업무 프로세스

### 3.1 SNMP 기반 모니터링 구조

- Java 1.7 + Spring Scheduler를 이용한 **주기적 SNMP Polling** 수행
- Polling 주기: **3 ~ 10초** (설정 가능)

#### Polling 수행 시 처리 흐름
1. 서비스별 각 서버(NBP / DR)에 대해 SNMP 요청
2. 세션 수 / 트래픽 지표 조회
3. 서비스 단위로 NBP 합계 / DR 합계 계산
4. 실시간 메모리 캐시 업데이트
5. 날짜별 로그 파일에 append

#### SNMP 오류 처리
- SNMP 오류 발생 시 **직전 정상 값 유지**
- 연속 오류 발생 시 UI에 경고 상태 표시

---

### 3.2 실시간 데이터 처리 구조

- 서비스별 **현재 상태 데이터 1건만 유지**
- Polling 반복 시 기존 데이터를 덮어쓰는 방식
- 메모리 누적 없음
- API 요청 시 **메모리 캐시만 참조**

---

### 3.3 최근 10분 이력 (메모리 Ring Buffer)

- 서비스별로 최근 N개 데이터만 저장
  - 예: Polling 5초 기준, 120개 = 약 10분
- Ring Buffer는 FIFO 구조
- 오래된 데이터는 자동 삭제
- UI의 **최근 10분 그래프**는 Ring Buffer 데이터를 사용

---

### 3.4 로그 파일 기반 24시간 이력 조회

- 당일 로그 + 전일 로그 파일을 대상으로 조회
- 현재 시각 기준 **최근 24시간 이후 데이터만 필터링**
- 데이터 과다 방지를 위해 **5분 단위 Downsampling**
- 최종 약 **288 포인트 (24시간 × 12개/시간)** 반환

---

### 3.5 최대 3개월 이력 조회 (집계 로그 기반)

- 장기 이력은 원본 로그를 직접 조회하지 않고,
  **일별 집계 로그 파일**을 생성하여 제공한다.

#### 집계 파일 생성 배치
- 수행 시각: 매일 00:05
- 처리 내용:
  - 전일 로그 파일을 서비스별로 5분 단위 집계
  - 결과를 `/logs/summary/YYYYMMDD.csv` 형태로 저장

#### 조회 시 처리 방식
1. 요청 기간(최대 90일)에 해당하는 집계 파일 로딩
2. 해당 서비스의 데이터만 필터링
3. 시간순으로 정렬 후 UI에 전달

---

## 4. 주요 기능 요구사항

### 4.1 서비스 목록 조회
- **API**: `/api/services`
- 서비스명, 서비스 유형(L4 / GLB)
- 서버 구성
- 현재 NBP / DR 비율
- 에러 상태 여부

---

### 4.2 서비스 상세 조회 (실시간)
- **API**: `/api/services/{id}/ratio`
- 현재 NBP / DR 값 및 비율
- 마지막 갱신 시간
- 최근 10분 Ring Buffer 기반 그래프 데이터

---

### 4.3 최근 24시간 이력 그래프
- **API**: `/api/services/{id}/history?hours=24`
- 로그 기반 5분 단위 집계
- 최대 288 포인트

---

### 4.4 최대 3개월 이력 그래프
- **API**: `/api/services/{id}/history?days=90`
- 집계 로그 기반
- 5분 단위 또는 30분 단위 (성능/가독성 고려)

---

### 4.5 에러 및 상태 표시
- SNMP 오류: 빨간색 / 노란색 상태 표시
- 데이터 미수집: 회색 상태 표시

---

## 5. 비기능 요구사항

### 5.1 성능
- 실시간 API 응답: **1초 미만**
- 서비스 30개 / 서버 100대 규모 처리 가능
- 90일 이력 조회 API: **1 ~ 2초 내 응답 목표**

---

### 5.2 안정성
- 캐시는 덮어쓰기 & 고정 길이 구조
- 장기 이력은 집계 파일 기반 조회
- 원본 로그는 일정 기간 이후 압축 또는 정리

---

### 5.3 보안
- SNMP Community 문자열은 properties 파일에서 암호화 또는 마스킹
- 웹 페이지는 외부망에서도 접근 가능
- 모니터링 서버는 내부망에서만 접근 가능

---
